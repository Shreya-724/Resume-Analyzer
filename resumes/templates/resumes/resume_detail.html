{% extends 'resumes/base.html' %}

{% block content %}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'resume_list' %}">My Resumes</a></li>
                <li class="breadcrumb-item active" aria-current="page">Resume Analysis</li>
            </ol>
        </nav>
    </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1"><i class="fas fa-file-alt me-2"></i>{{ resume.original_filename }}</h2>
        <p class="text-muted">Uploaded {{ resume.uploaded_at|timesince }} ago</p>
    </div>
    <a href="{% url 'resume_list' %}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-1"></i> Back to List
    </a>
</div>

<div class="row">
    <!-- Left Column - Resume Info & Skills -->
    <div class="col-lg-5 mb-4">
        <!-- Resume Information Card -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Resume Information</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-sm-4 fw-bold">Filename:</div>
                    <div class="col-sm-8">{{ resume.original_filename }}</div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4 fw-bold">Uploaded:</div>
                    <div class="col-sm-8">{{ resume.uploaded_at|date:"M d, Y H:i" }}</div>
                </div>
                <div class="row">
                    <div class="col-sm-4 fw-bold">File Size:</div>
                    <div class="col-sm-8">{{ resume.file.size|filesizeformat }}</div>
                </div>
            </div>
        </div>

        <!-- Skills Card -->
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-tools me-2"></i>Detected Skills</h5>
            </div>
            <div class="card-body">
                {% if resume.skills %}
                <div class="d-flex flex-wrap gap-2">
                    {% for skill in resume.skills %}
                    <span class="badge skill-badge p-2">
                        <i class="fas fa-check-circle me-1"></i>{{ skill }}
                    </span>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-exclamation-circle fa-2x text-muted mb-3"></i>
                    <p class="text-muted mb-0">No skills detected in this resume.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Right Column - Extracted Text -->
    <div class="col-lg-7 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-file-text me-2"></i>Extracted Text</h5>
            </div>
            <div class="card-body">
                <div class="extracted-text-container bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto;">
                    {{ resume.extracted_text|linebreaks }}
                </div>
                <div class="mt-3 text-end">
                    <small class="text-muted">{{ resume.extracted_text|wordcount }} words extracted</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Job Recommendations Section -->
<div class="card shadow-sm mt-4">
    <div class="card-header bg-warning text-dark">
        <h5 class="mb-0"><i class="fas fa-briefcase me-2"></i>Job Recommendations</h5>
    </div>
    <div class="card-body">
        {% if recommendations %}
        <p class="text-muted mb-4">Based on your skills and experience, we've found these perfect matches for you:</p>
        
        <div class="row">
            {% for job, score in recommendations %}
            <div class="col-md-6 mb-4">
                <div class="card h-100 job-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h5 class="card-title">{{ job.title }}</h5>
                            <span class="badge {% if score > 0.7 %}match-high{% elif score > 0.4 %}match-medium{% else %}match-low{% endif %} p-2">
                                {{ score|floatformat:2 }} Match
                            </span>
                        </div>
                        
                        <h6 class="card-subtitle mb-3 text-primary">
                            <i class="fas fa-building me-1"></i>{{ job.company }}
                            {% if job.location %}
                            <span class="text-muted ms-2">
                                <i class="fas fa-map-marker-alt me-1"></i>{{ job.location }}
                            </span>
                            {% endif %}
                        </h6>
                        
                        <p class="card-text">{{ job.description|truncatewords:30 }}</p>
                        
                        {% if job.required_skills %}
                        <div class="mb-3">
                            <h6 class="text-sm mb-2"><i class="fas fa-tools me-1"></i>Required Skills:</h6>
                            <div class="d-flex flex-wrap gap-1">
                                {% for skill in job.required_skills|slice:":5" %}
                                <span class="badge bg-secondary">{{ skill }}</span>
                                {% endfor %}
                                {% if job.required_skills|length > 5 %}
                                <span class="badge bg-light text-dark">+{{ job.required_skills|length|add:"-5" }} more</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <small class="text-muted">
                                <i class="fas fa-calendar me-1"></i>Posted {{ job.posted_date|date:"M d, Y" }}
                            </small>
                            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#jobModal{{ forloop.counter }}">
                                View Details
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-search fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No Job Recommendations Available</h5>
            <p class="text-muted">Make sure you have jobs in the database or try uploading a different resume.</p>
            <a href="{% url 'resume_upload' %}" class="btn btn-primary mt-2">
                <i class="fas fa-upload me-1"></i> Upload Another Resume
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Action Buttons -->
<div class="d-flex justify-content-between mt-4">
    <div>
        <a href="{% url 'resume_list' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i> Back to List
        </a>
    </div>
    <div>
        <!--<button class="btn btn-outline-primary me-2">
            <i class="fas fa-download me-1"></i> Download Report
        </button>-->
        <button class="btn btn-primary">
            <i class="fas fa-share-alt me-1"></i> Download Report
        </button>
    </div>
</div>

<!-- Modals placed at the bottom of the page (outside any loops) -->
{% for job, score in recommendations %}
<div class="modal fade" id="jobModal{{ forloop.counter }}" tabindex="-1" aria-labelledby="jobModalLabel{{ forloop.counter }}" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="jobModalLabel{{ forloop.counter }}">{{ job.title }} at {{ job.company }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p><strong><i class="fas fa-building me-2"></i>Company:</strong> {{ job.company }}</p>
                    </div>
                    {% if job.location %}
                    <div class="col-md-6">
                        <p><strong><i class="fas fa-map-marker-alt me-2"></i>Location:</strong> {{ job.location }}</p>
                    </div>
                    {% endif %}
                    <div class="col-md-6">
                        <p><strong><i class="fas fa-calendar me-2"></i>Posted:</strong> {{ job.posted_date|date:"M d, Y" }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong><i class="fas fa-chart-line me-2"></i>Match Score:</strong> 
                            <span class="badge {% if score > 0.7 %}match-high{% elif score > 0.4 %}match-medium{% else %}match-low{% endif %}">
                                {{ score|floatformat:2 }}
                            </span>
                        </p>
                    </div>
                </div>
                
                <h6>Job Description</h6>
                <p class="mb-4">{{ job.description }}</p>
                
                {% if job.required_skills %}
                <h6>Required Skills</h6>
                <div class="d-flex flex-wrap gap-2 mb-4">
                    {% for skill in job.required_skills %}
                    <span class="badge bg-primary">{{ skill }}</span>
                    {% endfor %}
                </div>
                {% endif %}
                
                <div class="alert alert-info">
                    <i class="fas fa-lightbulb me-2"></i>This position matches <strong>{{ resume.original_filename }}</strong> with a similarity score of <strong>{{ score|floatformat:2 }}</strong>.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <!--<button type="button" class="btn btn-primary">
                    <i class="fas fa-paper-plane me-1"></i> Apply Now
                </button>-->
            </div>
        </div>
    </div>
</div>
{% endfor %}

<style>
.job-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: 1px solid rgba(0,0,0,0.125);
}

.job-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
}

.extracted-text-container {
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
    line-height: 1.6;
}

.text-sm {
    font-size: 0.875rem;
}

.breadcrumb {
    background-color: transparent;
    padding: 0;
}

.breadcrumb-item a {
    text-decoration: none;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add animation to job cards
    const jobCards = document.querySelectorAll('.job-card');
    jobCards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
        card.classList.add('animate__animated', 'animate__fadeInUp');
    });
    
    // Add animation to skill badges
    const skillBadges = document.querySelectorAll('.skill-badge');
    skillBadges.forEach((badge, index) => {
        badge.style.animationDelay = `${index * 0.05}s`;
        badge.classList.add('animate__animated', 'animate__fadeIn');
    });
    
    // Initialize all modals properly
    var modals = document.querySelectorAll('.modal');
    modals.forEach(function(modal) {
        modal.addEventListener('shown.bs.modal', function () {
            // Focus on the close button when modal is shown
            var closeButton = this.querySelector('.btn-close');
            if (closeButton) {
                closeButton.focus();
            }
        });
    });
});
</script>
{% endblock %}